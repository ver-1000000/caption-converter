(()=>{var R=Object.create,O=Object.defineProperty,X=Object.getPrototypeOf,V=Object.prototype.hasOwnProperty,Y=Object.getOwnPropertyNames,Z=Object.getOwnPropertyDescriptor;var G=l=>O(l,"__esModule",{value:!0});var J=(l,i)=>()=>(i||(i={exports:{}},l(i.exports,i)),i.exports);var K=(l,i,c)=>{if(i&&typeof i=="object"||typeof i=="function")for(let g of Y(i))!V.call(l,g)&&g!=="default"&&O(l,g,{get:()=>i[g],enumerable:!(c=Z(i,g))||c.enumerable});return l},Q=l=>K(G(O(l!=null?R(X(l)):{},"default",l&&l.__esModule&&"default"in l?{get:()=>l.default,enumerable:!0}:{value:l,enumerable:!0})),l);var W=J(k=>{(function(){var l={direction:"horizontal",snapToLines:!0,linePosition:"auto",lineAlign:"start",textPosition:"auto",positionAlign:"auto",size:100,alignment:"center"},i=function(s){s||(s={"&amp":"&","&lt":"<","&gt":">","&lrm":"\u200E","&rlm":"\u200F","&nbsp":"\xA0"}),this.entities=s,this.parse=function(v,y){v=v.replace(/\0/g,"\uFFFD");var T=/\r\n|\r|\n/,r=Date.now(),e=0,n=v.split(T),f=!1,o=[],u=[];function a(b,_){u.push({message:b,line:e+1,col:_})}var d=n[e],t=d.length,h="WEBVTT",E=0,S=h.length;for(d[0]==="\uFEFF"&&(E=1,S+=1),(t<S||d.indexOf(h)!==0+E||t>S&&d[S]!==" "&&d[S]!=="	")&&a('No valid signature. (File needs to start with "WEBVTT".)'),e++;n[e]!=""&&n[e]!=null;){if(a("No blank line after the signature."),n[e].indexOf("-->")!=-1){f=!0;break}e++}for(;n[e]!=null;){for(var m;!f&&n[e]=="";)e++;if(!f&&n[e]==null)break;m=Object.assign({},l,{id:"",startTime:0,endTime:0,pauseOnExit:!1,direction:"horizontal",snapToLines:!0,linePosition:"auto",lineAlign:"start",textPosition:"auto",positionAlign:"auto",size:100,alignment:"center",text:"",tree:null});var x=!0;if(n[e].indexOf("-->")==-1){if(m.id=n[e],/^NOTE($|[ \t])/.test(m.id)){for(e++;n[e]!=""&&n[e]!=null;)n[e].indexOf("-->")!=-1&&a("Cannot have timestamp in a comment."),e++;continue}if(e++,n[e]==""||n[e]==null){a("Cue identifier cannot be standalone.");continue}if(n[e].indexOf("-->")==-1){x=!1,a("Cue identifier needs to be followed by timestamp.");continue}}f=!1;var p=new c(n[e],a),M=0;if(o.length>0&&(M=o[o.length-1].startTime),x&&!p.parse(m,M)){for(m=null,e++;n[e]!=""&&n[e]!=null;){if(n[e].indexOf("-->")!=-1){f=!0;break}e++}continue}for(e++;n[e]!=""&&n[e]!=null;){if(n[e].indexOf("-->")!=-1){a("Blank line missing before cue."),f=!0;break}m.text!=""&&(m.text+=`
`),m.text+=n[e],e++}var A=new g(m.text,a,y,this.entities);m.tree=A.parse(m.startTime,m.endTime),o.push(m)}return o.sort(function(b,_){return b.startTime<_.startTime?-1:b.startTime>_.startTime?1:b.endTime>_.endTime?-1:b.endTime<_.endTime?1:0}),{cues:o,errors:u,time:Date.now()-r}}},c=function(s,v){var y=/[\u0020\t\f]/,T=/[^\u0020\t\f]/,s=s,r=0,e=function(d){v(d,r+1)},n=!0;function f(d){for(;s[r]!=null&&d.test(s[r]);)r++}function o(d){for(var t="";s[r]!=null&&d.test(s[r]);)t+=s[r],r++;return t}function u(){var d="minutes",t,h,E,S;if(s[r]==null){e("No timestamp found.");return}if(!/\d/.test(s[r])){e("Timestamp must start with a character in the range 0-9.");return}if(t=o(/\d/),(t.length>2||parseInt(t,10)>59)&&(d="hours"),s[r]!=":"){e("No time unit separator found.");return}if(r++,h=o(/\d/),h.length!=2){e("Must be exactly two digits.");return}if(d=="hours"||s[r]==":"){if(s[r]!=":"){e("No seconds found or minutes is greater than 59.");return}if(r++,E=o(/\d/),E.length!=2){e("Must be exactly two digits.");return}}else{if(t.length!=2){e("Must be exactly two digits.");return}E=h,h=t,t="0"}if(s[r]!="."){e('No decimal separator (".") found.');return}if(r++,S=o(/\d/),S.length!=3){e("Milliseconds must be given in three digits.");return}if(parseInt(h,10)>59){e("You cannot have more than 59 minutes.");return}if(parseInt(E,10)>59){e("You cannot have more than 59 seconds.");return}return parseInt(t,10)*60*60+parseInt(h,10)*60+parseInt(E,10)+parseInt(S,10)/1e3}function a(d,t){for(var h=d.split(y),E=[],S=0;S<h.length;S++)if(h[S]!=""){var m=h[S].indexOf(":"),x=h[S].slice(0,m),p=h[S].slice(m+1);if(E.indexOf(x)!=-1&&e("Duplicate setting."),E.push(x),p==""){e("No value for setting defined.");return}if(x=="vertical"){if(p!="rl"&&p!="lr"){e("Writing direction can only be set to 'rl' or 'rl'.");continue}t.direction=p}else if(x=="line"){if(/,/.test(p)){var M=p.split(",");p=M[0];var A=M[1]}if(!/^[-\d](\d*)(\.\d+)?%?$/.test(p)){e("Line position takes a number or percentage.");continue}if(p.indexOf("-",1)!=-1){e("Line position can only have '-' at the start.");continue}if(p.indexOf("%")!=-1&&p.indexOf("%")!=p.length-1){e("Line position can only have '%' at the end.");continue}if(p[0]=="-"&&p[p.length-1]=="%"){e("Line position cannot be a negative percentage.");continue}var b=p,_=!1;if(p[p.length-1]=="%"&&(_=!0,b=p.slice(0,p.length-1),parseInt(p,10)>100)){e("Line position cannot be >100%.");continue}if(b===""||isNaN(b)||!isFinite(b)){e("Line position needs to be a number");continue}if(A!==void 0){if(!["start","center","end"].includes(A)){e("Line alignment needs to be one of start, center or end");continue}t.lineAlign=A}t.snapToLines=!_,t.linePosition=parseFloat(b),parseFloat(b).toString()!==b&&(t.nonSerializable=!0)}else if(x=="position"){if(/,/.test(p)){var M=p.split(",");p=M[0];var z=M[1]}if(p[p.length-1]!="%"){e("Text position must be a percentage.");continue}if(parseInt(p,10)>100||parseInt(p,10)<0){e("Text position needs to be between 0 and 100%.");continue}if(b=p.slice(0,p.length-1),b===""||isNaN(b)||!isFinite(b)){e("Line position needs to be a number");continue}if(z!==void 0){if(!["line-left","center","line-right"].includes(z)){e("Position alignment needs to be one of line-left, center or line-right");continue}t.positionAlign=z}t.textPosition=parseFloat(b)}else if(x=="size"){if(p[p.length-1]!="%"){e("Size must be a percentage.");continue}if(parseInt(p,10)>100){e("Size cannot be >100%.");continue}var I=p.slice(0,p.length-1);if(I===void 0||I===""||isNaN(I)){e("Size needs to be a number"),I=100;continue}else if(I=parseFloat(I),I<0||I>100){e("Size needs to be between 0 and 100%.");continue}t.size=I}else if(x=="align"){var H=["start","center","end","left","right"];if(H.indexOf(p)==-1){e("Alignment can only be set to one of "+H.join(", ")+".");continue}t.alignment=p}else e("Invalid setting.")}}this.parse=function(d,t){if(f(y),d.startTime=u(),d.startTime!=null){if(d.startTime<t&&e("Start timestamp is not greater than or equal to start timestamp of previous cue."),T.test(s[r])&&e("Timestamp not separated from '-->' by whitespace."),f(y),s[r]!="-"){e("No valid timestamp separator found.");return}if(r++,s[r]!="-"){e("No valid timestamp separator found.");return}if(r++,s[r]!=">"){e("No valid timestamp separator found.");return}if(r++,T.test(s[r])&&e("'-->' not separated from timestamp by whitespace."),f(y),d.endTime=u(),d.endTime!=null)return d.endTime<=d.startTime&&e("End timestamp is not greater than start timestamp."),T.test(s[r])&&(n=!1),f(y),a(s.substring(r),d),!0}},this.parseTimestamp=function(){var d=u();if(s[r]!=null){e("Timestamp must not have trailing characters.");return}return d}},g=function(s,v,y,T){this.entities=T;var r=this,s=s,e=0,n=function(o){y!="metadata"&&v(o,e+1)};this.parse=function(o,u){function a(A){let b={...A};return A.children&&(b.children=A.children.map(a)),b.parent&&delete b.parent,b}var d={children:[]},t=d,h=[];function E(A){t.children.push({type:"object",name:A[1],classes:A[2],children:[],parent:t}),t=t.children[t.children.length-1]}function S(A){for(var b=t;b;){if(b.name==A)return!0;b=b.parent}}for(;s[e]!=null;){var m=f();if(m[0]=="text")t.children.push({type:"text",value:m[1],parent:t});else if(m[0]=="start tag"){y=="chapters"&&n("Start tags not allowed in chapter title text.");var x=m[1];x!="v"&&x!="lang"&&m[3]!=""&&n("Only <v> and <lang> can have an annotation."),x=="c"||x=="i"||x=="b"||x=="u"||x=="ruby"||x=="rt"&&t.name=="ruby"?E(m):x=="v"?(S("v")&&n("<v> cannot be nested inside itself."),E(m),t.value=m[3],m[3]||n("<v> requires an annotation.")):x=="lang"?(E(m),t.value=m[3]):n("Incorrect start tag.")}else if(m[0]=="end tag")y=="chapters"&&n("End tags not allowed in chapter title text."),m[1]==t.name?t=t.parent:m[1]=="ruby"&&t.name=="rt"?t=t.parent.parent:n("Incorrect end tag.");else if(m[0]=="timestamp"){y=="chapters"&&n("Timestamp not allowed in chapter title text.");var p=new c(m[1],n),M=p.parseTimestamp();M!=null&&((M<=o||M>=u)&&n("Timestamp must be between start timestamp and end timestamp."),h.length>0&&h[h.length-1]>=M&&n("Timestamp must be greater than any previous timestamp."),t.children.push({type:"timestamp",value:M,parent:t}),h.push(M))}}for(;t.parent;)t.name!="v"&&n("Required end tag missing."),t=t.parent;return a(d)};function f(){for(var o="data",u="",a="",d=[];s[e-1]!=null||e==0;){var t=s[e];if(o=="data")if(t=="&")a=t,o="escape";else if(t=="<"&&u=="")o="tag";else{if(t=="<"||t==null)return["text",u];u+=t}else if(o=="escape")if(t=="<"||t==null){n("Incorrect escape.");let h;return(h=a.match(/^&#([0-9]+)$/))?u+=String.fromCharCode(h[1]):r.entities[a]?u+=r.entities[a]:u+=a,["text",u]}else if(t=="&")n("Incorrect escape."),u+=a,a=t;else if(/[a-z#0-9]/i.test(t))a+=t;else if(t==";"){let h;(h=a.match(/^&#(x?[0-9]+)$/))?u+=String.fromCharCode("0"+h[1]):r.entities[a+t]?u+=r.entities[a+t]:(h=Object.keys(T).find(E=>a.startsWith(E)))?u+=r.entities[h]+a.slice(h.length)+t:(n("Incorrect escape."),u+=a+";"),o="data"}else n("Incorrect escape."),u+=a+t,o="data";else if(o=="tag")if(t=="	"||t==`
`||t=="\f"||t==" ")o="start tag annotation";else if(t==".")o="start tag class";else if(t=="/")o="end tag";else if(/\d/.test(t))u=t,o="timestamp tag";else{if(t==">"||t==null)return t==">"&&e++,["start tag","",[],""];u=t,o="start tag"}else if(o=="start tag")if(t=="	"||t=="\f"||t==" ")o="start tag annotation";else if(t==`
`)a=t,o="start tag annotation";else if(t==".")o="start tag class";else{if(t==">"||t==null)return t==">"&&e++,["start tag",u,[],""];u+=t}else if(o=="start tag class")if(t=="	"||t=="\f"||t==" ")a&&d.push(a),a="",o="start tag annotation";else if(t==`
`)a&&d.push(a),a=t,o="start tag annotation";else if(t==".")a&&d.push(a),a="";else{if(t==">"||t==null)return t==">"&&e++,a&&d.push(a),["start tag",u,d,""];a+=t}else if(o=="start tag annotation"){if(t==">"||t==null)return t==">"&&e++,a=a.split(/[\u0020\t\f\r\n]+/).filter(function(h){if(h)return!0}).join(" "),["start tag",u,d,a];a+=t}else if(o=="end tag"){if(t==">"||t==null)return t==">"&&e++,["end tag",u];u+=t}else if(o=="timestamp tag"){if(t==">"||t==null)return t==">"&&e++,["timestamp",u];u+=t}else n("Never happens.");e++}}},w=function(){function s(r){let e=(""+(r-Math.floor(r)).toFixed(3)*1e3).padEnd(3,"0"),n=0,f=0,o=0;return r>=3600&&(n=Math.floor(r/3600)),f=Math.floor((r-3600*n)/60),o=Math.floor(r-3600*n-60*f),(n?n+":":"")+(""+f).padStart(2,"0")+":"+(""+o).padStart(2,"0")+"."+e}function v(r){var e="";let n=Object.keys(l).filter(f=>r[f]!==l[f]);return n.includes("direction")&&(e+=" vertical:"+r.direction),n.includes("alignment")&&(e+=" align:"+r.alignment),n.includes("size")&&(e+=" size:"+r.size+"%"),(n.includes("lineAlign")||n.includes("linePosition"))&&(e+=" line:"+r.linePosition+(r.snapToLines?"":"%")+(r.lineAlign&&r.lineAlign!=l.lineAlign?","+r.lineAlign:"")),(n.includes("textPosition")||n.includes("positionAlign"))&&(e+=" position:"+r.textPosition+"%"+(r.positionAlign&&r.positionAlign!==l.positionAlign?","+r.positionAlign:"")),e}function y(r){for(var e="",n=0;n<r.length;n++){var f=r[n];if(f.type=="text")e+=f.value.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");else if(f.type=="object"){if(e+="<"+f.name,f.classes)for(var o=0;o<f.classes.length;o++)e+="."+f.classes[o];f.value&&(e+=" "+f.value),e+=">",f.children&&(e+=y(f.children)),e+="</"+f.name+">"}else f.type=="timestamp"?e+="<"+s(f.value)+">":e+="<"+f.value+">"}return e}function T(r){return(r.id?r.id+`
`:"")+s(r.startTime)+" --> "+s(r.endTime)+v(r)+`
`+y(r.tree.children)+`

`}this.serialize=function(r){for(var e=`WEBVTT

`,n=0;n<r.length;n++)e+=T(r[n]);return e}};function L(s){s.WebVTTParser=i,s.WebVTTCueTimingsAndSettingsParser=c,s.WebVTTCueTextParser=g,s.WebVTTSerializer=w}typeof window!="undefined"&&L(window),typeof k!="undefined"&&L(k)})()});var D=Q(W());var B="0.2.2";function N(l){if(l==null)throw new Error(`Expected 'val' to be defined, but received ${l}`)}var j=new DOMParser,ee=new D.WebVTTParser,te=new XMLSerializer,P={width:1280,height:720},q=j.parseFromString(`<?xml version="1.0" standalone="no"?>
<mlt LC_NUMERIC="C" version="6.24.0" title="Shotcut created by Caption Converter" producer="main_bin">
  <profile description="automatic" width="${P.width}" height="${P.height}" progressive="1" sample_aspect_num="1" sample_aspect_den="1" display_aspect_num="16" display_aspect_den="9" frame_rate_num="30" frame_rate_den="1" colorspace="709"/>
  <playlist id="main_bin">
    <property name="xml_retain">1</property>
  </playlist>
  <producer id="black" in="00:00:00.000" out="00:09:59.960">
    <property name="length">1</property>
    <property name="eof">pause</property>
    <property name="resource">0</property>
    <property name="aspect_ratio">1</property>
    <property name="mlt_service">color</property>
    <property name="mlt_image_format">rgb24a</property>
    <property name="set.test_audio">0</property>
  </producer>
  <playlist id="background">
    <entry producer="black" in="00:00:00.000" out="00:00:00.000"/>
  </playlist>
  <tractor id="tractor0" title="Shotcut created by Caption Converter" global_feed="1" in="00:00:00.000" out="00:00:00.000">
    <property name="shotcut">1</property>
    <track producer="background"/>
    <transition id="transition1">
      <property name="a_track">0</property>
      <property name="b_track">1</property>
      <property name="mlt_service">frei0r.cairoblend</property>
      <property name="disable">1</property>
    </transition>
  </tractor>
`,"text/xml"),C={trackSize:3,cues:new Array,xml:q,width:P.width,height:P.height,fields:[{field:"#a#",color:"#ed514e"},{field:"#h#",color:"#5bad92"},{field:"",color:"#eec34f"}],options:{trackSize:3,transition:!1}},$=(l,i=document)=>{let c=i.querySelector(l);return N(c),c},F=l=>{let i=Object.assign(document.createElement("xml"),{innerHTML:l}).firstElementChild;return N(i),i},re=l=>{let i=l.cloneNode(!0);if(i.querySelector("tractor")==null){let c=F(`
      <tractor id="tractor0" title="Shotcut created by Caption Converter" global_feed="1" in="00:00:00.000" out="00:00:00.000">
        <property name="shotcut">1</property>
      </tractor>
    `);i.firstChild?.insertBefore(c,null)}return i},ne=(l,i,c)=>{let g=r=>r.split(":").reduce((e,n)=>e.map(f=>f*60).concat(Number(n)),[]).reduce((e,n)=>e+n),w=r=>(r=Math.max(0,r),[...[Math.floor(r/3600),Math.floor(r/60%60)].map(e=>String(e).padStart(2,"0")),(r%60).toFixed(3)].join(":")),L=[...l.querySelectorAll("blank,entry")].reduce((r,e)=>r+g(e.getAttribute("length")||"")+g(e.getAttribute("out")||""),0),s=document.createElement("blank"),v=document.createElement("entry"),y=i.startTime-L,T=Math.min(y,0);s.setAttribute("length",w(y)),v.setAttribute("out",w(i.endTime-i.startTime+T)),v.setAttribute("producer",`${i.id}-producer${c+1}`),v.dataset.cue=i.text.substr(0,5),v.dataset.spent=w(L)+"-"+y,l.appendChild(s),l.appendChild(v)},U=class{constructor(i){this.storeService=i}playlist(i){return F(`
    <playlist id="playlistcaptionconverter${i}">
      <property name="shotcut:video">${i}</property>
      <property name="shotcut:name">CAP${i}</property>
    </playlist>
    `)}track(i){return F(`<track producer="${i.id}"/>`)}transition(i,c){let g=[...c.querySelectorAll('[name="b_track"]')].reduce((w,L)=>Math.max(Number(L.textContent),w),0)+1;return F(`
    <transition id="transitioncaptionconverter${i}">
      <property name="a_track">1</property>
      <property name="b_track">${g}</property>
      <property name="mlt_service">frei0r.cairoblend</property>
      <property name="disable">0</property>
    </transition>
    `)}producer(i,c){let g=this.storeService.fields.find(v=>i.text.includes(v.field))?.color,w=Number(((v=i.text.match(/#outline:\d+#/)?.[0])=>(v||"#outline:12#").replace(/#outline:(\d+)#/,"$1"))()),L=()=>this.storeService.options.transition?`<filter id="${i.id}-transitionfilter${c}">
        <property name="mlt_service">affine</property>
        <property name="shotcut:filter">affineSizePosition</property>
        <property name="transition.rect">0 0 ${this.storeService.width} ${this.storeService.height} 1</property>
      </filter>`:"",s=(v,y,T,r)=>`<filter id="${i.id}-simpletextfilter${v}">
        <property name="argument">${i.text}</property>
        <property name="geometry">0 240 ${this.storeService.width} ${this.storeService.height-240} 1</property>
        <property name="family">Rounded-X Mgen+ 1c</property>
        <property name="size">96</property>
        <property name="weight">750</property>
        <property name="fgcolour">#ffffff</property>
        <property name="bgcolour">#00000000</property>
        <property name="olcolour">${y}</property>
        <property name="outline">${T}</property>
        <property name="pad">${r}</property>
        <property name="halign">center</property>
        <property name="valign">${["bottom","middle","top"][c%3]}</property>
        <property name="mlt_service">dynamictext</property>
        <property name="shotcut:filter">dynamicText</property>
        <property name="shotcut:usePointSize">1</property>
        <property name="shotcut:pointSize">72</property>
      </filter>`;return F(`
    <producer id="${i.id}-producer${c+1}">
      <property name="resource">#00000000</property>
      <property name="mlt_service">color</property>
      <property name="shotcut:caption">${i.text}</property>
      ${g&&w?s(1,g,w,0):""}
      ${s(g&&w?2:1,"#00000000",0,w/2)}
      ${L()}
    </producer>
    `)}},ie=l=>{let i=async g=>await(c?.elements.namedItem(g)).files?.[0]?.text()||"",c=l.target.form;N(c),(async()=>{let g=await i("webvtt"),w=ee.parse(g).cues,L=$("#actionBtn");C.cues=w,g?L.removeAttribute("disabled"):L.setAttribute("disabled","")})(),(async()=>{let g=await i("mlt"),w=g?j.parseFromString(g,"text/xml"):q;C.xml=w})()},se=l=>{let i=l.target.form;N(i),[...i.elements].forEach(c=>C.fields[Number(c.dataset.index)][c.name]=c.value)},ae=l=>{let i=l.target.form;N(i),C.options.trackSize=i.elements.namedItem("trackSize").valueAsNumber,C.options.transition=i.elements.namedItem("transition").checked},oe=async l=>{let i=re(C.xml),c=$("mlt",i),g=$("tractor",c),w=g.querySelector("transition"),L=new U(C),s=Array.from(Array(C.trackSize)).map((y,T)=>{let r=L.playlist(T+1);return c.insertBefore(r,g),r});C.cues.forEach((y,T)=>{let r=L.producer(y,T),e=s[T%C.trackSize];ne(e,y,T),c.insertBefore(r,e)}),s.forEach(y=>{let T=L.track(y);g.insertBefore(T,w)}),s.forEach((y,T)=>{let r=L.transition(T,c);g.insertBefore(r,null)}),c.querySelectorAll('[xmlns="http://www.w3.org/1999/xhtml"]').forEach(y=>y.removeAttributeNS(null,"xmlns"));let v=te.serializeToString(i).replaceAll(' xmlns="http://www.w3.org/1999/xhtml"',"");l.target.href=URL.createObjectURL(new Blob([v],{type:"text/plain"}))};addEventListener("load",()=>{$("#filesForm").oninput=ie,$("#colorsForm").oninput=se,$("#optionsForm").oninput=ae,$("#actionBtn").onclick=oe,$("#version").textContent=B});})();
