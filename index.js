(()=>{var q=Object.create,H=Object.defineProperty,j=Object.getPrototypeOf,U=Object.prototype.hasOwnProperty,R=Object.getOwnPropertyNames,X=Object.getOwnPropertyDescriptor;var Y=i=>H(i,"__esModule",{value:!0});var Z=(i,o)=>()=>(o||(o={exports:{}},i(o.exports,o)),o.exports);var G=(i,o,m)=>{if(o&&typeof o=="object"||typeof o=="function")for(let T of R(o))!U.call(i,T)&&T!=="default"&&H(i,T,{get:()=>o[T],enumerable:!(m=X(o,T))||m.enumerable});return i},J=i=>G(Y(H(i!=null?q(j(i)):{},"default",i&&i.__esModule&&"default"in i?{get:()=>i.default,enumerable:!0}:{value:i,enumerable:!0})),i);var W=Z(k=>{(function(){var i={direction:"horizontal",snapToLines:!0,linePosition:"auto",lineAlign:"start",textPosition:"auto",positionAlign:"auto",size:100,alignment:"center"},o=function(a){a||(a={"&amp":"&","&lt":"<","&gt":">","&lrm":"\u200E","&rlm":"\u200F","&nbsp":"\xA0"}),this.entities=a,this.parse=function(b,h){b=b.replace(/\0/g,"\uFFFD");var x=/\r\n|\r|\n/,n=Date.now(),e=0,r=b.split(x),f=!1,l=[],c=[];function s(y,_){c.push({message:y,line:e+1,col:_})}var d=r[e],t=d.length,g="WEBVTT",w=0,E=g.length;for(d[0]==="\uFEFF"&&(w=1,E+=1),(t<E||d.indexOf(g)!==0+w||t>E&&d[E]!==" "&&d[E]!=="	")&&s('No valid signature. (File needs to start with "WEBVTT".)'),e++;r[e]!=""&&r[e]!=null;){if(s("No blank line after the signature."),r[e].indexOf("-->")!=-1){f=!0;break}e++}for(;r[e]!=null;){for(var u;!f&&r[e]=="";)e++;if(!f&&r[e]==null)break;u=Object.assign({},i,{id:"",startTime:0,endTime:0,pauseOnExit:!1,direction:"horizontal",snapToLines:!0,linePosition:"auto",lineAlign:"start",textPosition:"auto",positionAlign:"auto",size:100,alignment:"center",text:"",tree:null});var v=!0;if(r[e].indexOf("-->")==-1){if(u.id=r[e],/^NOTE($|[ \t])/.test(u.id)){for(e++;r[e]!=""&&r[e]!=null;)r[e].indexOf("-->")!=-1&&s("Cannot have timestamp in a comment."),e++;continue}if(e++,r[e]==""||r[e]==null){s("Cue identifier cannot be standalone.");continue}if(r[e].indexOf("-->")==-1){v=!1,s("Cue identifier needs to be followed by timestamp.");continue}}f=!1;var p=new m(r[e],s),S=0;if(l.length>0&&(S=l[l.length-1].startTime),v&&!p.parse(u,S)){for(u=null,e++;r[e]!=""&&r[e]!=null;){if(r[e].indexOf("-->")!=-1){f=!0;break}e++}continue}for(e++;r[e]!=""&&r[e]!=null;){if(r[e].indexOf("-->")!=-1){s("Blank line missing before cue."),f=!0;break}u.text!=""&&(u.text+=`
`),u.text+=r[e],e++}var M=new T(u.text,s,h,this.entities);u.tree=M.parse(u.startTime,u.endTime),l.push(u)}return l.sort(function(y,_){return y.startTime<_.startTime?-1:y.startTime>_.startTime?1:y.endTime>_.endTime?-1:y.endTime<_.endTime?1:0}),{cues:l,errors:c,time:Date.now()-n}}},m=function(a,b){var h=/[\u0020\t\f]/,x=/[^\u0020\t\f]/,a=a,n=0,e=function(d){b(d,n+1)},r=!0;function f(d){for(;a[n]!=null&&d.test(a[n]);)n++}function l(d){for(var t="";a[n]!=null&&d.test(a[n]);)t+=a[n],n++;return t}function c(){var d="minutes",t,g,w,E;if(a[n]==null){e("No timestamp found.");return}if(!/\d/.test(a[n])){e("Timestamp must start with a character in the range 0-9.");return}if(t=l(/\d/),(t.length>2||parseInt(t,10)>59)&&(d="hours"),a[n]!=":"){e("No time unit separator found.");return}if(n++,g=l(/\d/),g.length!=2){e("Must be exactly two digits.");return}if(d=="hours"||a[n]==":"){if(a[n]!=":"){e("No seconds found or minutes is greater than 59.");return}if(n++,w=l(/\d/),w.length!=2){e("Must be exactly two digits.");return}}else{if(t.length!=2){e("Must be exactly two digits.");return}w=g,g=t,t="0"}if(a[n]!="."){e('No decimal separator (".") found.');return}if(n++,E=l(/\d/),E.length!=3){e("Milliseconds must be given in three digits.");return}if(parseInt(g,10)>59){e("You cannot have more than 59 minutes.");return}if(parseInt(w,10)>59){e("You cannot have more than 59 seconds.");return}return parseInt(t,10)*60*60+parseInt(g,10)*60+parseInt(w,10)+parseInt(E,10)/1e3}function s(d,t){for(var g=d.split(h),w=[],E=0;E<g.length;E++)if(g[E]!=""){var u=g[E].indexOf(":"),v=g[E].slice(0,u),p=g[E].slice(u+1);if(w.indexOf(v)!=-1&&e("Duplicate setting."),w.push(v),p==""){e("No value for setting defined.");return}if(v=="vertical"){if(p!="rl"&&p!="lr"){e("Writing direction can only be set to 'rl' or 'rl'.");continue}t.direction=p}else if(v=="line"){if(/,/.test(p)){var S=p.split(",");p=S[0];var M=S[1]}if(!/^[-\d](\d*)(\.\d+)?%?$/.test(p)){e("Line position takes a number or percentage.");continue}if(p.indexOf("-",1)!=-1){e("Line position can only have '-' at the start.");continue}if(p.indexOf("%")!=-1&&p.indexOf("%")!=p.length-1){e("Line position can only have '%' at the end.");continue}if(p[0]=="-"&&p[p.length-1]=="%"){e("Line position cannot be a negative percentage.");continue}var y=p,_=!1;if(p[p.length-1]=="%"&&(_=!0,y=p.slice(0,p.length-1),parseInt(p,10)>100)){e("Line position cannot be >100%.");continue}if(y===""||isNaN(y)||!isFinite(y)){e("Line position needs to be a number");continue}if(M!==void 0){if(!["start","center","end"].includes(M)){e("Line alignment needs to be one of start, center or end");continue}t.lineAlign=M}t.snapToLines=!_,t.linePosition=parseFloat(y),parseFloat(y).toString()!==y&&(t.nonSerializable=!0)}else if(v=="position"){if(/,/.test(p)){var S=p.split(",");p=S[0];var z=S[1]}if(p[p.length-1]!="%"){e("Text position must be a percentage.");continue}if(parseInt(p,10)>100||parseInt(p,10)<0){e("Text position needs to be between 0 and 100%.");continue}if(y=p.slice(0,p.length-1),y===""||isNaN(y)||!isFinite(y)){e("Line position needs to be a number");continue}if(z!==void 0){if(!["line-left","center","line-right"].includes(z)){e("Position alignment needs to be one of line-left, center or line-right");continue}t.positionAlign=z}t.textPosition=parseFloat(y)}else if(v=="size"){if(p[p.length-1]!="%"){e("Size must be a percentage.");continue}if(parseInt(p,10)>100){e("Size cannot be >100%.");continue}var A=p.slice(0,p.length-1);if(A===void 0||A===""||isNaN(A)){e("Size needs to be a number"),A=100;continue}else if(A=parseFloat(A),A<0||A>100){e("Size needs to be between 0 and 100%.");continue}t.size=A}else if(v=="align"){var F=["start","center","end","left","right"];if(F.indexOf(p)==-1){e("Alignment can only be set to one of "+F.join(", ")+".");continue}t.alignment=p}else e("Invalid setting.")}}this.parse=function(d,t){if(f(h),d.startTime=c(),d.startTime!=null){if(d.startTime<t&&e("Start timestamp is not greater than or equal to start timestamp of previous cue."),x.test(a[n])&&e("Timestamp not separated from '-->' by whitespace."),f(h),a[n]!="-"){e("No valid timestamp separator found.");return}if(n++,a[n]!="-"){e("No valid timestamp separator found.");return}if(n++,a[n]!=">"){e("No valid timestamp separator found.");return}if(n++,x.test(a[n])&&e("'-->' not separated from timestamp by whitespace."),f(h),d.endTime=c(),d.endTime!=null)return d.endTime<=d.startTime&&e("End timestamp is not greater than start timestamp."),x.test(a[n])&&(r=!1),f(h),s(a.substring(n),d),!0}},this.parseTimestamp=function(){var d=c();if(a[n]!=null){e("Timestamp must not have trailing characters.");return}return d}},T=function(a,b,h,x){this.entities=x;var n=this,a=a,e=0,r=function(l){h!="metadata"&&b(l,e+1)};this.parse=function(l,c){function s(M){let y={...M};return M.children&&(y.children=M.children.map(s)),y.parent&&delete y.parent,y}var d={children:[]},t=d,g=[];function w(M){t.children.push({type:"object",name:M[1],classes:M[2],children:[],parent:t}),t=t.children[t.children.length-1]}function E(M){for(var y=t;y;){if(y.name==M)return!0;y=y.parent}}for(;a[e]!=null;){var u=f();if(u[0]=="text")t.children.push({type:"text",value:u[1],parent:t});else if(u[0]=="start tag"){h=="chapters"&&r("Start tags not allowed in chapter title text.");var v=u[1];v!="v"&&v!="lang"&&u[3]!=""&&r("Only <v> and <lang> can have an annotation."),v=="c"||v=="i"||v=="b"||v=="u"||v=="ruby"||v=="rt"&&t.name=="ruby"?w(u):v=="v"?(E("v")&&r("<v> cannot be nested inside itself."),w(u),t.value=u[3],u[3]||r("<v> requires an annotation.")):v=="lang"?(w(u),t.value=u[3]):r("Incorrect start tag.")}else if(u[0]=="end tag")h=="chapters"&&r("End tags not allowed in chapter title text."),u[1]==t.name?t=t.parent:u[1]=="ruby"&&t.name=="rt"?t=t.parent.parent:r("Incorrect end tag.");else if(u[0]=="timestamp"){h=="chapters"&&r("Timestamp not allowed in chapter title text.");var p=new m(u[1],r),S=p.parseTimestamp();S!=null&&((S<=l||S>=c)&&r("Timestamp must be between start timestamp and end timestamp."),g.length>0&&g[g.length-1]>=S&&r("Timestamp must be greater than any previous timestamp."),t.children.push({type:"timestamp",value:S,parent:t}),g.push(S))}}for(;t.parent;)t.name!="v"&&r("Required end tag missing."),t=t.parent;return s(d)};function f(){for(var l="data",c="",s="",d=[];a[e-1]!=null||e==0;){var t=a[e];if(l=="data")if(t=="&")s=t,l="escape";else if(t=="<"&&c=="")l="tag";else{if(t=="<"||t==null)return["text",c];c+=t}else if(l=="escape")if(t=="<"||t==null){r("Incorrect escape.");let g;return(g=s.match(/^&#([0-9]+)$/))?c+=String.fromCharCode(g[1]):n.entities[s]?c+=n.entities[s]:c+=s,["text",c]}else if(t=="&")r("Incorrect escape."),c+=s,s=t;else if(/[a-z#0-9]/i.test(t))s+=t;else if(t==";"){let g;(g=s.match(/^&#(x?[0-9]+)$/))?c+=String.fromCharCode("0"+g[1]):n.entities[s+t]?c+=n.entities[s+t]:(g=Object.keys(x).find(w=>s.startsWith(w)))?c+=n.entities[g]+s.slice(g.length)+t:(r("Incorrect escape."),c+=s+";"),l="data"}else r("Incorrect escape."),c+=s+t,l="data";else if(l=="tag")if(t=="	"||t==`
`||t=="\f"||t==" ")l="start tag annotation";else if(t==".")l="start tag class";else if(t=="/")l="end tag";else if(/\d/.test(t))c=t,l="timestamp tag";else{if(t==">"||t==null)return t==">"&&e++,["start tag","",[],""];c=t,l="start tag"}else if(l=="start tag")if(t=="	"||t=="\f"||t==" ")l="start tag annotation";else if(t==`
`)s=t,l="start tag annotation";else if(t==".")l="start tag class";else{if(t==">"||t==null)return t==">"&&e++,["start tag",c,[],""];c+=t}else if(l=="start tag class")if(t=="	"||t=="\f"||t==" ")s&&d.push(s),s="",l="start tag annotation";else if(t==`
`)s&&d.push(s),s=t,l="start tag annotation";else if(t==".")s&&d.push(s),s="";else{if(t==">"||t==null)return t==">"&&e++,s&&d.push(s),["start tag",c,d,""];s+=t}else if(l=="start tag annotation"){if(t==">"||t==null)return t==">"&&e++,s=s.split(/[\u0020\t\f\r\n]+/).filter(function(g){if(g)return!0}).join(" "),["start tag",c,d,s];s+=t}else if(l=="end tag"){if(t==">"||t==null)return t==">"&&e++,["end tag",c];c+=t}else if(l=="timestamp tag"){if(t==">"||t==null)return t==">"&&e++,["timestamp",c];c+=t}else r("Never happens.");e++}}},C=function(){function a(n){let e=(""+(n-Math.floor(n)).toFixed(3)*1e3).padEnd(3,"0"),r=0,f=0,l=0;return n>=3600&&(r=Math.floor(n/3600)),f=Math.floor((n-3600*r)/60),l=Math.floor(n-3600*r-60*f),(r?r+":":"")+(""+f).padStart(2,"0")+":"+(""+l).padStart(2,"0")+"."+e}function b(n){var e="";let r=Object.keys(i).filter(f=>n[f]!==i[f]);return r.includes("direction")&&(e+=" vertical:"+n.direction),r.includes("alignment")&&(e+=" align:"+n.alignment),r.includes("size")&&(e+=" size:"+n.size+"%"),(r.includes("lineAlign")||r.includes("linePosition"))&&(e+=" line:"+n.linePosition+(n.snapToLines?"":"%")+(n.lineAlign&&n.lineAlign!=i.lineAlign?","+n.lineAlign:"")),(r.includes("textPosition")||r.includes("positionAlign"))&&(e+=" position:"+n.textPosition+"%"+(n.positionAlign&&n.positionAlign!==i.positionAlign?","+n.positionAlign:"")),e}function h(n){for(var e="",r=0;r<n.length;r++){var f=n[r];if(f.type=="text")e+=f.value.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");else if(f.type=="object"){if(e+="<"+f.name,f.classes)for(var l=0;l<f.classes.length;l++)e+="."+f.classes[l];f.value&&(e+=" "+f.value),e+=">",f.children&&(e+=h(f.children)),e+="</"+f.name+">"}else f.type=="timestamp"?e+="<"+a(f.value)+">":e+="<"+f.value+">"}return e}function x(n){return(n.id?n.id+`
`:"")+a(n.startTime)+" --> "+a(n.endTime)+b(n)+`
`+h(n.tree.children)+`

`}this.serialize=function(n){for(var e=`WEBVTT

`,r=0;r<n.length;r++)e+=x(n[r]);return e}};function I(a){a.WebVTTParser=o,a.WebVTTCueTimingsAndSettingsParser=m,a.WebVTTCueTextParser=T,a.WebVTTSerializer=C}typeof window!="undefined"&&I(window),typeof k!="undefined"&&I(k)})()});var B=J(W());function P(i){if(i==null)throw new Error(`Expected 'val' to be defined, but received ${i}`)}var D=new DOMParser,K=new B.WebVTTParser,Q=new XMLSerializer,O={width:1280,height:720},V=D.parseFromString(`<mlt LC_NUMERIC="C" version="6.24.0" title="Shotcut created by Caption Converter" producer="main_bin">
  <profile description="automatic" width="${O.width}" height="${O.height}" progressive="1" sample_aspect_num="1" sample_aspect_den="1" display_aspect_num="16" display_aspect_den="9" frame_rate_num="30" frame_rate_den="1" colorspace="709"/>
  <playlist id="main_bin">
    <property name="xml_retain">1</property>
  </playlist>
  <producer id="black" in="00:00:00.000" out="00:09:59.960">
    <property name="length">1</property>
    <property name="eof">pause</property>
    <property name="resource">0</property>
    <property name="aspect_ratio">1</property>
    <property name="mlt_service">color</property>
    <property name="mlt_image_format">rgb24a</property>
    <property name="set.test_audio">0</property>
  </producer>
  <playlist id="background">
    <entry producer="black" in="00:00:00.000" out="00:00:00.000"/>
  </playlist>
  <tractor id="tractor0" title="Shotcut created by Caption Converter" global_feed="1" in="00:00:00.000" out="00:00:00.000">
    <property name="shotcut">1</property>
    <track producer="background"/>
    <transition id="transition1">
      <property name="a_track">0</property>
      <property name="b_track">1</property>
      <property name="mlt_service">frei0r.cairoblend</property>
      <property name="disable">1</property>
    </transition>
  </tractor>
`,"text/xml"),L={trackSize:3,cues:new Array,xml:V,width:O.width,height:O.height,fields:[{field:"#a#",color:"#ed514e"},{field:"#h#",color:"#5bad92"},{field:"",color:"#eec34f"}],options:{transition:!1}},$=(i,o=document)=>{let m=o.querySelector(i);return P(m),m},ee=async i=>{L.trackSize=i.target.valueAsNumber},te=async i=>{let o=i.target.files?.[0],m=String(await o?.text()),T=K.parse(m).cues;L.cues=T},ne=async i=>{let o=i.target.files?.[0],m=String(await o?.text()),T=D.parseFromString(m,"text/xml");L.xml=T},re=i=>{let o=i.target.form;P(o),[...o.elements].forEach(m=>L.fields[Number(m.dataset.index)][m.name]=m.value)},ie=i=>{let o=i.target.form;P(o),L.options.transition=o.elements.namedItem("transition").checked},de=async i=>{let o=ae(L.xml),m=$("mlt",o),T=$("tractor",m),C=T.querySelector("transition"),I=Array.from(Array(L.trackSize)).map((b,h)=>{let x=se(h+1);return m.insertBefore(x,T),x});L.cues.forEach((b,h)=>{let x=fe(b,h),n=I[h%L.trackSize];oe(n,b,h),m.insertBefore(x,n)}),I.forEach(b=>{let h=le(b);T.insertBefore(h,C)}),I.forEach((b,h)=>{let x=pe(h,m);T.insertBefore(x,null)}),m.querySelectorAll('[xmlns="http://www.w3.org/1999/xhtml"]').forEach(b=>b.removeAttributeNS(null,"xmlns"));let a=Q.serializeToString(o).replaceAll(' xmlns="http://www.w3.org/1999/xhtml"',"");i.target.href=URL.createObjectURL(new Blob([a],{type:"text/plain"}))},ae=i=>{let o=i.cloneNode(!0);if(o.querySelector("tractor")==null){let m=N(`
      <tractor id="tractor0" title="Shotcut created by Caption Converter" global_feed="1" in="00:00:00.000" out="00:00:00.000">
        <property name="shotcut">1</property>
      </tractor>
    `);o.firstChild?.insertBefore(m,null)}return o},oe=(i,o,m)=>{let T=n=>n.split(":").reduce((e,r)=>e.map(f=>f*60).concat(Number(r)),[]).reduce((e,r)=>e+r),C=n=>(n=Math.max(0,n),[...[Math.floor(n/3600),Math.floor(n/60%60)].map(e=>String(e).padStart(2,"0")),(n%60).toFixed(3)].join(":")),I=[...i.querySelectorAll("blank,entry")].reduce((n,e)=>n+T(e.getAttribute("length")||"")+T(e.getAttribute("out")||""),0),a=document.createElement("blank"),b=document.createElement("entry"),h=o.startTime-I,x=Math.min(h,0);a.setAttribute("length",C(h)),b.setAttribute("out",C(o.endTime-o.startTime+x)),b.setAttribute("producer",`${o.id}-producer${m+1}`),b.dataset.cue=o.text.substr(0,5),b.dataset.spent=C(I)+"-"+h,i.appendChild(a),i.appendChild(b)},N=i=>{let o=Object.assign(document.createElement("xml"),{innerHTML:i}).firstElementChild;return P(o),o},se=i=>N(`
  <playlist id="playlistcaptionconverter${i}">
    <property name="shotcut:video">${i}</property>
    <property name="shotcut:name">CAP${i}</property>
  </playlist>
  `),le=i=>N(`<track producer="${i.id}"/>`),pe=(i,o)=>{let m=[...o.querySelectorAll('[name="b_track"]')].reduce((T,C)=>Math.max(Number(C.textContent),T),0)+1;return N(`
  <transition id="transitioncaptionconverter${i}">
    <property name="a_track">1</property>
    <property name="b_track">${m}</property>
    <property name="mlt_service">frei0r.cairoblend</property>
    <property name="disable">0</property>
  </transition>
  `)},fe=(i,o)=>{let m=L.fields.find(a=>i.text.includes(a.field))?.color,T=Number(((a=i.text.match(/#outline:\d+#/)?.[0])=>(a||"#outline:12#").replace(/#outline:(\d+)#/,"$1"))()),C=()=>L.options.transition?`<filter id="${i.id}-transitionfilter${o}">
      <property name="mlt_service">affine</property>
      <property name="shotcut:filter">affineSizePosition</property>
      <property name="transition.rect">0 0 ${L.width} ${L.height} 1</property>
    </filter>`:"",I=(a,b,h,x)=>`<filter id="${i.id}-simpletextfilter${a}">
      <property name="argument">${i.text}</property>
      <property name="geometry">0 240 ${L.width} ${L.height-240} 1</property>
      <property name="family">Rounded-X Mgen+ 1c</property>
      <property name="size">96</property>
      <property name="weight">750</property>
      <property name="fgcolour">#ffffff</property>
      <property name="bgcolour">#00000000</property>
      <property name="olcolour">${b}</property>
      <property name="outline">${h}</property>
      <property name="pad">${x}</property>
      <property name="halign">center</property>
      <property name="valign">${["bottom","middle","top"][o%3]}</property>
      <property name="mlt_service">dynamictext</property>
      <property name="shotcut:filter">dynamicText</property>
      <property name="shotcut:usePointSize">1</property>
      <property name="shotcut:pointSize">72</property>
    </filter>`;return N(`
  <producer id="${i.id}-producer${o+1}">
    <property name="resource">#00000000</property>
    <property name="mlt_service">color</property>
    <property name="shotcut:caption">${i.text}</property>
    ${m&&T?I(1,m,T,0):""}
    ${I(m&&T?2:1,"#00000000",0,T/2)}
    ${C()}
  </producer>
  `)};addEventListener("load",()=>{$("#trackSizeInput").oninput=ee,$("#webvttInput").oninput=te,$("#mltInput").oninput=ne,$("#colorForm").oninput=re,$("#optionsForm").oninput=ie,$("#actionBtn").onclick=de});})();
